---
author: "S. Tinapunan"
date: "May 16, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br> 

### Data 608 - Visual Analytics 

- Final Project by S. Tinapunan 
- The purpose of this file is to prepare the data that's going to be used by the Shiny application that I'm going to build.

---


### Data set

<b>September 2014 Uber Pickups</b>

- This is taken from https://www.kaggle.com/fivethirtyeight/uber-pickups-in-new-york-city/version/2. 
- This is a list of Uber pickups for the month of September 2014 only. 
- This file has 1,028,136 rows. 


<b> New York City Zip Codes </b>

- This is taken from https://www.health.ny.gov/statistics/cancer/registry/appendix/neighborhoods.htm. 
- This is a list of 178 zip codes with neighborhood and borough descriptions. 
- This is the CSV format of this data that's been transformed: <br> https://raw.githubusercontent.com/Shetura36/Data-607-Assignments/master/FinalProject/NYC_Borough_Neighborhood_ZipCodes.csv


<b> Reverse Geocoding Output </b>

The NYC Uber data set for pick up locations include longitude and latitude information; however, it does not contain information such as zip codes, borough, or neighborhood. One of my projects for Data 607 is to take geolocation data and convert them into zip code, borough, and neighborhood. A detailed step by step of how this was estimated is described [here](https://github.com/Shetura36/Data-607-Assignments/blob/master/FinalProject/Data607-Final-Project-Version2.md). 


- Output file of reverse geocoding of the NYC Uber 2014 pickup location: <br> https://raw.githubusercontent.com/Shetura36/Data-607-Assignments/master/FinalProject/Pickup_Zipcodes.csv
- This file has 1,028,136 rows. 

---

### Output file generated by this job

The CSV version of this file was over 100 MB in size. I did not save this file in Github.  

- https://github.com/Shetura36/Data-608/blob/master/Final%20Project/NYC_Uber_pickup_Sept2014_output.rds?raw=true

---

### Load libraries

```{r}
library(dplyr)
library(zipcode)
```

---

### Prepare data 

The code below loads the data from the file sources mentioned above into objects. 

```{r}
file_NYC_zipcodes <- "https://raw.githubusercontent.com/Shetura36/Data-607-Assignments/master/FinalProject/NYC_Borough_Neighborhood_ZipCodes.csv"
file_reverseGeo_output <- "https://raw.githubusercontent.com/Shetura36/Data-607-Assignments/master/FinalProject/Pickup_Zipcodes.csv"

#column names for the reverse geocoding output
col_names <- c("row_id","pickup_datetime","latitude","longitude","base","location_index","distance","zip")
NYC_pickup_sept2014 <- readr::read_csv(file_reverseGeo_output, skip = 1, col_names)

#mapping of NYC zip codes to borough and neighborhoods
NYC_zipcodes <- readr::read_csv(file_NYC_zipcodes)
```

The data frame `NYC_pickup_sept2014` includes mapping of (longitude, latitude) to estimated zip codes. A detailed step by step of how the estimate was done is described [here](https://github.com/Shetura36/Data-607-Assignments/blob/master/FinalProject/Data607-Final-Project-Version2.md). 

If the estimate is more than 2,000 meters (around 1.24 miles) from the published zip code to (longitude, latitude) mapping in the `zipcode` library, these rows were dropped. 

The `zipcode` library contains over 44,000 mappings of zip codes to (longitude, latitude) in the United States. 

The code below will remove rows that are more than 2000 meters.

```{r}
pickup_info_far <- NYC_pickup_sept2014[NYC_pickup_sept2014$distance >= 2001,]
pickup_info_nyc <- NYC_pickup_sept2014[NYC_pickup_sept2014$distance < 2001,]
```

50,636 rows were removed from 1,028,136 pickup locations.

```{r}
nrow(pickup_info_far)
```

977,500 Remaining rows with estimated zip codes that are within 1.24 miles of the zip code to (longitude, latitude) mapping as published in the `zipcode` library. 


```{r}
nrow(pickup_info_nyc)
```

Join pickup data with estimated zip codes to NYC borough and neighborhood and city, state, and official zip code long/lat mapping. 

```{r}
NYC_Uber_pickup_Sept2014 <- dplyr::inner_join(pickup_info_nyc, NYC_zipcodes, by = "zip")
NYC_Uber_pickup_Sept2014$zip <- as.character(NYC_Uber_pickup_Sept2014$zip)
NYC_Uber_pickup_Sept2014 <- dplyr::inner_join(NYC_Uber_pickup_Sept2014, zipcode, by = "zip")

#remove columns that are not necessary
NYC_Uber_pickup_Sept2014$X1 <- NULL
NYC_Uber_pickup_Sept2014$location_index <- NULL
  
names(NYC_Uber_pickup_Sept2014)[3] <- "latitude.pickup"
names(NYC_Uber_pickup_Sept2014)[4] <- "longitude.pickup"

names(NYC_Uber_pickup_Sept2014)[12] <- "latitude.zipcode"
names(NYC_Uber_pickup_Sept2014)[13] <- "longitude.zipcode"
```

Preview data

```{r}
head(NYC_Uber_pickup_Sept2014)
```


Save this data as CSV and RDS file. 

This file data is going to be used by the Shiny application. 

```{r}
saveRDS(NYC_Uber_pickup_Sept2014, "NYC_Uber_pickup_Sept2014.rds")
write.csv(NYC_Uber_pickup_Sept2014, file='NYC_Uber_pickup_Sept2014.csv')
```


---

S. Tinapunan, 5/16/2019
